<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工商信息查询系统</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6.26.0/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                axios.get('hhttps://business-query-worker.26935955.workers.dev/api/history')
                    .then(res => {
                        console.log('History response:', res.data);
                        setHistory(res.data);
                    })
                    .catch(err => {
                        const errMsg = (err.response && err.response.data && err.response.data.error) || err.message;
                        console.error('History error:', errMsg);
                        setError('加载历史记录失败: ' + errMsg);
                    });
            }, []);

            const handleQuery = async () => {
                if (!query.trim()) {
                    setError('请输入公司名称');
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    const companies = query.split('\n').filter(name => name.trim());
                    console.log('Sending query:', { companies });
                    const response = await axios.post('hhttps://business-query-worker.26935955.workers.dev/api/query', { companies });
                    console.log('Query response:', response.data);
                    setResults(response.data.results || []);
                    const historyRes = await axios.get('hhttps://business-query-worker.26935955.workers.dev/api/history');
                    setHistory(historyRes.data);
                } catch (err) {
                    const errMsg = (err.response && err.response.data && err.response.data.error) || err.message;
                    console.error('Query error:', errMsg);
                    setError('查询失败: ' + errMsg + '。请稍后重试或检查企查查官网。');
                }
                setLoading(false);
            };

            const exportToExcel = () => {
                const ws = XLSX.utils.json_to_sheet(results);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '查询结果');
                XLSX.writeFile(wb, '工商信息查询结果.xlsx');
            };

            return (
                <div className="container mx-auto p-6 bg-gray-100 min-h-screen">
                    <h1 className="text-3xl font-bold text-center mb-6">工商信息查询系统</h1>
                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                        <textarea
                            className="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="5"
                            placeholder="输入公司名称，每行一个"
                            value={query}
                            onChange={e => setQuery(e.target.value)}
                        ></textarea>
                        <div className="flex justify-end mt-4">
                            <button
                                className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 disabled:bg-gray-400"
                                onClick={handleQuery}
                                stanno cercando di fare qualcosa di nuovo e di interessante, ma non sono sicuro di come si svilupperà.